<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“¢ å…¬å‘Šç‰†æ¯”è¼ƒ</title>
  <link rel="stylesheet" href="/css/bulletin.css">
  <style>
    .compare-container { display: flex; gap: 40px; }
    .compare-column { flex: 1; border: 1px solid #ccc; padding: 1em; border-radius: 8px; background: #fffdf6; }
    h2 { margin-bottom: 0.2em; }
  </style>
</head>
<body>
  <h1>ðŸ“¢ å…¬å‘Šç‰†é¡¯ç¤ºç‰ˆæœ¬æ¯”è¼ƒ</h1>
  <div class="compare-container">
    <div class="compare-column">
      <h2>ðŸ§¾ èˆŠç‰ˆï¼ˆdisplay.jsï¼‰</h2>
      <div id="old-bulletin"></div>
    </div>
    <div class="compare-column">
      <h2>âœ¨ æ–°ç‰ˆï¼ˆbulletin.jsï¼‰</h2>
      <div id="new-bulletin"></div>
    </div>
  </div>

  <script type="module">
    import { db } from '/js/firebase.js'
    import {
      collection, getDocs, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js'

    const groupMap = {
      'å¤–å ´': 'ðŸ“Œ å¤–å ´',
      'å…§å ´': 'ðŸ“Œ å…§å ´',
      'å‡ºè²¨': 'ðŸ“Œ å‡ºè²¨',
      'ç¾Žç·¨': 'ðŸ“Œ ç¾Žç·¨',
      'è¡ŒéŠ·': 'ðŸ“Œ è¡ŒéŠ·'
    }

    async function renderOldVersion() {
      const q = query(collection(db, 'bulletin'), orderBy('createdAt', 'desc'))
      const snapshot = await getDocs(q)
      const grouped = {}

      snapshot.forEach(doc => {
        const d = doc.data()
        const lines = d.content.split('\n')
        const group = d.targetGroup || 'æœªåˆ†é¡ž'
        if (!grouped[group]) grouped[group] = []
        grouped[group].push({ nickname: d.nickname, lines })
      })

      const container = document.getElementById('old-bulletin')
      Object.keys(grouped).forEach(group => {
        const title = groupMap[group] || `ðŸ“Œ ${group}`
        const section = document.createElement('div')
        section.innerHTML = `<h3>${title}</h3>`
        grouped[group].forEach(msg => {
          const html = msg.lines.map((line, i) => i === 0
            ? `<strong>${msg.nickname}</strong>: ${line}`
            : `<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${line}`).join('')
          section.innerHTML += `<div class="msg-line">${html}</div><br>`
        })
        container.appendChild(section)
      })
    }

    async function renderNewVersion() {
      const q = query(collection(db, 'bulletin'), orderBy('createdAt', 'desc'))
      const snapshot = await getDocs(q)
      const grouped = {}

      snapshot.forEach(doc => {
        const d = doc.data()
        const lines = d.content.split('\n')
        const group = d.targetGroup || 'æœªåˆ†é¡ž'
        if (!grouped[group]) grouped[group] = []
        grouped[group].push({ nickname: d.nickname, lines })
      })

      const container = document.getElementById('new-bulletin')
      Object.keys(grouped).forEach(group => {
        const groupTitle = groupMap[group] || `ðŸ“Œ ${group}`
        const section = document.createElement('div')
        section.innerHTML = `<h3>${groupTitle}</h3>`
        grouped[group].forEach(msg => {
          const first = msg.lines[0]
          const rest = msg.lines.slice(1).map(l => `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${l}`).join('<br>')
          const entry = `<div class="msg-line">ðŸ”¹ <strong>${msg.nickname}</strong>: ${first}<br>${rest}</div>`
          section.innerHTML += entry
        })
        container.appendChild(section)
      })
    }

    renderOldVersion()
    renderNewVersion()
  </script>
</body>
</html>
